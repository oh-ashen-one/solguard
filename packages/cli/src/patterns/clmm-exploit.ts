import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL140: CLMM/Concentrated Liquidity Exploit (Crema, Raydium patterns)
 * 
 * Detects vulnerabilities specific to concentrated liquidity market
 * makers (CLMMs) and AMM implementations.
 */
export function checkClmmExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];

  if (!input.rust || !input.rust.files) return findings;

  for (const file of input.rust.files) {
    const lines = file.lines;
    const content = file.content;

    lines.forEach((line, index) => {
      const lineNum = index + 1;
      const lineLower = line.toLowerCase();

      // Pattern 1: Position/tick manipulation without bounds check
      if ((lineLower.includes('position') || lineLower.includes('tick')) &&
          (lineLower.includes('lower') || lineLower.includes('upper'))) {
        const fnEnd = Math.min(lines.length, index + 15);
        const fnBody = lines.slice(index, fnEnd).join('\n').toLowerCase();
        
        if (!fnBody.includes('min_tick') && !fnBody.includes('max_tick') &&
            !fnBody.includes('tick_spacing')) {
          findings.push({
            id: `SOL140-${findings.length + 1}`,
            pattern: 'CLMM Exploit Vector',
            severity: 'high',
            title: 'Tick bounds not validated',
            description: 'Position tick bounds may not be properly validated. Invalid ticks could corrupt pool state.',
            location: { file: file.path, line: lineNum },
            suggestion: 'Validate: require!(lower_tick >= MIN_TICK && upper_tick <= MAX_TICK && lower_tick < upper_tick)',
          });
        }
      }

      // Pattern 2: Liquidity calculation without overflow protection
      if (lineLower.includes('liquidity') && 
          (lineLower.includes('add') || lineLower.includes('remove') || lineLower.includes('delta'))) {
        const fnEnd = Math.min(lines.length, index + 10);
        const fnBody = lines.slice(index, fnEnd).join('\n');
        
        if (!fnBody.includes('checked_') && !fnBody.includes('saturating_') && 
            !fnBody.includes('overflow')) {
          findings.push({
            id: `SOL140-${findings.length + 1}`,
            pattern: 'CLMM Exploit Vector',
            severity: 'high',
            title: 'Liquidity math without overflow protection',
            description: 'Liquidity calculations may overflow. Use checked math for all liquidity operations.',
            location: { file: file.path, line: lineNum },
            suggestion: 'Use checked math: liquidity.checked_add(delta).ok_or(MathOverflow)?',
          });
        }
      }

      // Pattern 3: Swap without slippage protection
      if (lineLower.includes('swap') && lineLower.includes('amount')) {
        const fnEnd = Math.min(lines.length, index + 25);
        const fnBody = lines.slice(index, fnEnd).join('\n').toLowerCase();
        
        if (!fnBody.includes('slippage') && !fnBody.includes('min_out') && 
            !fnBody.includes('amount_out_min') && !fnBody.includes('sqrt_price_limit')) {
          findings.push({
            id: `SOL140-${findings.length + 1}`,
            pattern: 'CLMM Exploit Vector',
            severity: 'critical',
            title: 'Swap without slippage protection',
            description: 'Swap has no minimum output or price limit. Vulnerable to sandwich attacks.',
            location: { file: file.path, line: lineNum },
            suggestion: 'Add slippage: require!(amount_out >= user_min_amount_out, SlippageExceeded)',
          });
        }
      }

      // Pattern 4: Fee growth calculation issues
      if (lineLower.includes('fee_growth') || lineLower.includes('fees_owed')) {
        const fnEnd = Math.min(lines.length, index + 15);
        const fnBody = lines.slice(index, fnEnd).join('\n').toLowerCase();
        
        if (fnBody.includes('global') && !fnBody.includes('snapshot') && !fnBody.includes('checkpoint')) {
          findings.push({
            id: `SOL140-${findings.length + 1}`,
            pattern: 'CLMM Exploit Vector',
            severity: 'high',
            title: 'Fee calculation without proper checkpointing',
            description: 'Fee growth calculation may not properly checkpoint global state. Could allow fee claiming manipulation.',
            location: { file: file.path, line: lineNum },
            suggestion: 'Store fee growth snapshot per position: position.fee_growth_inside_last',
          });
        }
      }

      // Pattern 5: Protocol fee extraction
      if (lineLower.includes('protocol_fee') && lineLower.includes('collect')) {
        const fnEnd = Math.min(lines.length, index + 20);
        const fnBody = lines.slice(index, fnEnd).join('\n').toLowerCase();
        
        if (!fnBody.includes('admin') && !fnBody.includes('authority') && !fnBody.includes('owner')) {
          findings.push({
            id: `SOL140-${findings.length + 1}`,
            pattern: 'CLMM Exploit Vector',
            severity: 'critical',
            title: 'Protocol fee collection without auth',
            description: 'Protocol fees can be collected without authority check.',
            location: { file: file.path, line: lineNum },
            suggestion: 'Require admin: #[account(address = config.protocol_fee_authority)]',
          });
        }
      }
    });
  }

  return findings;
}
